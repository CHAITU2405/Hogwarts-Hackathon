<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Hogwarts Hackathon</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Crimson+Text:ital,wght@0,400;1,400&family=Pinyon+Script&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --gold: #d4af37;
            --bg-dark: #0b0b0b;
            --card-bg: rgba(20, 20, 20, 0.9);
            --parchment: #d1c4a9;
            --ink: #2a1b15;
            --danger: #8a1c1c;
            --success: #1b5e20;
        }

        /* --- GLOBAL CURSOR RESET --- */
        html, body, button, a, input, select, textarea, .btn, .card, div, span, li, i {
            cursor: none !important;
        }

        body {
            background-color: var(--bg-dark);
            background: radial-gradient(circle at center, #1f1f35 0%, #000000 100%), url('https://www.transparenttextures.com/patterns/stardust.png');
            background-attachment: fixed;
            color: #eee;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- WAND CURSOR --- */
        @media (min-width: 992px) {
            *, html, body, a, button, input, label, select { cursor: none !important; }
            #wand { display: flex !important; }
        }
        #wand { 
            position: fixed; top: 0; left: 0; 
            width: 50px; height: auto; 
            pointer-events: none; z-index: 10000; will-change: transform; 
            transform-origin: top left; 
            filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.6)) drop-shadow(2px 3px 6px rgba(0,0,0,0.95)); 
            display: none; 
            animation: wandGlow 2s ease-in-out infinite;
        }
        #wand img {
            width: 100%;
            height: auto;
            display: block;
        }
        @keyframes wandGlow {
            0%, 100% { filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.6)) drop-shadow(2px 3px 6px rgba(0,0,0,0.95)); }
            50% { filter: drop-shadow(0 0 15px rgba(212, 175, 55, 0.8)) drop-shadow(2px 3px 8px rgba(0,0,0,0.95)) drop-shadow(0 0 20px rgba(255, 255, 100, 0.4)); }
        }
        
        .cursor-trail {
            position: fixed; width: 3px; height: 3px; background: var(--gold); border-radius: 50%; pointer-events: none; z-index: 9999;
            animation: fade-trail 0.5s linear forwards; box-shadow: 0 0 5px var(--gold); display: none;
        }
        @media (min-width: 992px) { .cursor-trail { display: block; } }
        @keyframes fade-trail { 0% { opacity: 0.8; transform: scale(1); } 100% { opacity: 0; transform: scale(0.2) translate(0, 10px); } }

        /* --- NAVBAR --- */
        .navbar { background: rgba(10, 10, 10, 0.95); border-bottom: 1px solid rgba(212, 175, 55, 0.3); }
        .navbar-brand { font-family: 'Cinzel Decorative'; color: var(--gold) !important; }
        .admin-badge { border: 1px solid var(--gold); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-left: 10px; color: var(--gold); }

        /* --- DASHBOARD LAYOUT --- */
        .dashboard-container { padding: 40px 20px; max-width: 1200px; margin: 0 auto; }
        .section-title { font-family: 'Cinzel Decorative'; color: var(--gold); text-align: center; margin-bottom: 30px; font-size: 2rem; text-shadow: 0 0 10px rgba(212,175,55,0.3); }

        /* STATS CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 50px; }
        .stat-card { background: var(--card-bg); border: 1px solid #444; border-radius: 8px; padding: 20px; text-align: center; transition: 0.3s; position: relative; overflow: hidden; }
        .stat-card:hover { border-color: var(--gold); transform: translateY(-5px); }
        .stat-number { font-family: 'Cinzel Decorative'; font-size: 2.5rem; color: #fff; line-height: 1; }
        .stat-label { font-family: 'Crimson Text'; color: #aaa; font-size: 1rem; text-transform: uppercase; margin-top: 5px; }
        .stat-icon { position: absolute; top: 10px; right: 10px; font-size: 3.5rem; opacity: 0.05; color: #fff; }
        .stat-card.main { background: linear-gradient(135deg, #2a0a0a, #000); border: 1px solid var(--gold); }
        .stat-card.main .stat-number { color: var(--gold); text-shadow: 0 0 15px var(--gold); }

        /* ACTION BAR & FILTERS */
        .control-panel { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 30px; gap: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        
        .btn-group-actions { display: flex; gap: 15px; }

        .action-btn {
            background: var(--gold); color: #000; border: none;
            font-family: 'Cinzel Decorative'; padding: 10px 20px; font-size: 1rem;
            cursor: pointer; transition: 0.3s; border-radius: 4px;
            display: flex; align-items: center;
        }
        .action-btn:hover { background: #fff; box-shadow: 0 0 15px #fff; }
        
        /* Specific style for Approve Button */
        .approve-btn {
            background: transparent; border: 2px solid var(--gold); color: var(--gold);
        }
        .approve-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 15px var(--gold); }

        .filter-group button {
            background: transparent; border: 1px solid #444; color: #aaa;
            padding: 5px 15px; border-radius: 20px; margin-left: 5px;
            font-family: 'Cinzel Decorative'; font-size: 0.8rem; cursor: pointer; transition: 0.3s;
        }
        .filter-group button.active, .filter-group button:hover { background: var(--gold); color: #000; border-color: var(--gold); }

        /* --- PROBLEM CARDS --- */
        .quest-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        
        .admin-card {
            background: rgba(20, 20, 20, 0.8); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; padding: 20px; display: flex; flex-direction: column;
            transition: 0.3s; position: relative;
        }
        .admin-card:hover { border-color: var(--gold); box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        .card-tag { 
            position: absolute; top: 15px; right: 15px; 
            font-size: 0.7rem; border: 1px solid var(--gold); color: var(--gold); 
            padding: 2px 6px; border-radius: 3px; text-transform: uppercase;
        }
        
        .card-title { font-family: 'Cinzel Decorative'; color: #fff; font-size: 1.3rem; margin-top: 10px; }
        .card-desc { font-family: 'Crimson Text'; color: #aaa; font-size: 1rem; flex-grow: 1; margin-bottom: 15px; }
        
        .card-meta { display: flex; justify-content: space-between; align-items: center; margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
        .count-display { color: #888; font-family: 'Crimson Text'; font-size: 0.9rem; }
        .count-display strong { color: var(--gold); font-size: 1.1rem; margin-right: 5px; }

        .card-actions { display: flex; gap: 10px; }
        .btn-icon { border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; transition: 0.3s; font-family: 'Cinzel Decorative'; font-size: 0.8rem; }
        .btn-view { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-view:hover { background: #fff; color: #000; }
        .btn-del { background: rgba(138, 28, 28, 0.2); color: #ff6b6b; border: 1px solid #8a1c1c; }
        .btn-del:hover { background: #8a1c1c; color: #fff; box-shadow: 0 0 10px #8a1c1c; }

        /* =========================================
           MODALS
           ========================================= */
        .parchment-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
            perspective: 1500px; 
        }
        .parchment-overlay.active { opacity: 1; pointer-events: auto; }

        /* Folding Map Container */
        .map-container {
            position: relative; width: 600px; height: 700px;
            transform-style: preserve-3d;
            transition: transform 1s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        /* FLAPS */
        .map-flap {
            position: absolute; top: 0; width: 50%; height: 100%;
            background-color: var(--parchment);
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            border: 1px solid #8d6e63; z-index: 20;
            transition: transform 1.2s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d; backface-visibility: hidden;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: inset 0 0 30px rgba(62, 39, 35, 0.3);
            filter: url(#wrinkle-paper);
        }
        .flap-left { left: 0; transform-origin: left center; border-right: 1px solid rgba(0,0,0,0.2); }
        .flap-right { right: 0; transform-origin: right center; border-left: 1px solid rgba(0,0,0,0.2); }

        .flap-content { font-family: 'Cinzel Decorative', cursive; color: var(--ink); font-size: 2.5rem; text-align: center; opacity: 0.8; }
        .map-container.open .flap-left { transform: rotateY(-180deg); }
        .map-container.open .flap-right { transform: rotateY(180deg); }

        /* INNER CONTENT */
        .map-inner {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #e6d3b3; 
            background-image: url('https://www.transparenttextures.com/patterns/aged-paper.png');
            display: flex; flex-direction: column; padding: 40px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5), inset 0 0 60px rgba(0,0,0,0.3);
            z-index: 5;
            filter: url(#wrinkle-paper) contrast(1.05);
            overflow-y: auto;
        }

        .close-modal {
            position: absolute; top: 20px; right: 20px;
            width: 40px; height: 40px; background: #7f0000; border-radius: 50%;
            border: 2px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10; transition: 0.3s;
        }
        .close-modal:hover { transform: scale(1.1); background: #900; }

        .scroll-title { font-family: 'Cinzel Decorative'; color: var(--ink); text-align: center; border-bottom: 2px solid var(--ink); padding-bottom: 10px; margin-bottom: 30px; font-size: 1.8rem; }

        /* Forms */
        .form-group { margin-bottom: 25px; position: relative; }
        .ink-label { font-family: 'Cinzel Decorative'; font-size: 0.9rem; color: #5d4037; margin-bottom: 5px; display: block; }
        .ink-input, .ink-textarea { width: 100%; background: transparent; border: none; border-bottom: 2px dashed var(--ink); font-family: 'Crimson Text'; font-size: 1.3rem; color: var(--ink); padding: 8px 5px; outline: none; }
        .ink-input:focus, .ink-textarea:focus { border-bottom: 2px solid var(--ink); background: rgba(62, 39, 35, 0.05); }

        /* Dropdowns */
        .custom-select-wrapper { position: relative; user-select: none; width: 100%; }
        .custom-select-trigger { position: relative; display: flex; align-items: center; justify-content: space-between; font-family: 'Crimson Text'; font-size: 1.3rem; color: var(--ink); padding: 8px 5px; cursor: pointer; border-bottom: 2px dashed var(--ink); background: transparent; transition: 0.3s; }
        .custom-select-trigger:after { content: '\f078'; font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 0.8rem; transition: 0.3s; }
        .custom-select-wrapper.open .custom-select-trigger:after { transform: rotate(180deg); }
        .custom-options { position: absolute; top: 100%; left: 0; right: 0; z-index: 100; background: #e6d3b3; border: 1px solid #8d6e63; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); opacity: 0; visibility: hidden; pointer-events: none; transform: translateY(-10px); transition: 0.3s; max-height: 200px; overflow-y: auto; }
        .custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; pointer-events: auto; transform: translateY(0); }
        .custom-option { display: block; padding: 10px 15px; font-family: 'Crimson Text'; font-size: 1.2rem; color: var(--ink); cursor: pointer; transition: 0.2s; border-bottom: 1px solid rgba(62, 39, 35, 0.1); }
        .custom-option:hover { background: rgba(62, 39, 35, 0.1); padding-left: 20px; color: #000; }
        
        .submit-seal-btn { width: 100%; background: var(--ink); color: var(--parchment); padding: 15px; font-family: 'Cinzel Decorative'; border: none; cursor: pointer; transition: 0.3s; font-size: 1.2rem; margin-top: 20px; clip-path: polygon(5% 0, 100% 0, 95% 100%, 0% 100%); }
        .submit-seal-btn:hover { background: #000; transform: scale(1.02); }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Simple Modal (View/Approve) */
        .simple-modal-frame .parchment-modal { transform: none; height: auto; max-height: 80vh; width: 600px; overflow-y: auto; margin-top: 5vh; border: 5px double #5d4037; background-color: #e6d3b3; }
        
        /* List Styling */
        .manifest-list { list-style: none; padding: 0; }
        .manifest-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px dashed rgba(42,27,21,0.3); color: var(--ink); font-family: 'Crimson Text'; font-size: 1.2rem; }
        .manifest-item:last-child { border-bottom: none; }
        
        /* Approval Actions */
        .approval-actions { display: flex; gap: 10px; }
        .btn-approve, .btn-reject { width: 35px; height: 35px; border-radius: 50%; border: none; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; font-size: 1rem; }
        .btn-approve { background: var(--success); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-approve:hover { background: #144a18; transform: scale(1.1); }
        .btn-reject { background: var(--danger); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .btn-reject:hover { background: #6b1515; transform: scale(1.1); }
        
        .team-info { display: flex; flex-direction: column; }
        .quest-name { font-size: 0.9rem; color: #5d4037; font-style: italic; }

    </style>
</head>
<body>

    <svg width="0" height="0" style="position: absolute;"><filter id="wrinkle-paper"><feTurbulence type="fractalNoise" baseFrequency="0.03" numOctaves="3" result="noise" /><feDiffuseLighting in="noise" lighting-color="#fff" surfaceScale="2"><feDistantLight azimuth="45" elevation="60" /></feDiffuseLighting><feComposite operator="in" in2="SourceGraphic" result="textured"/><feBlend mode="multiply" in="textured" in2="SourceGraphic"/></filter></svg>

    <div id="wand"><img src="assets/wand.png" alt="Wand cursor"></div>

    <nav class="navbar navbar-expand-lg sticky-top navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Hogwarts Hacks <span class="admin-badge">Admin</span></a>
            <div class="d-flex align-items-center">
                <span class="me-3" style="font-family: 'Crimson Text'; color: #aaa;" id="adminNameDisplay"></span>
                <a href="login.html" class="btn btn-sm btn-outline-secondary" style="font-family: 'Cinzel Decorative';" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <h2 class="section-title">The Chronicles</h2>
        <div class="stats-grid">
            <div class="stat-card main"><i class="fa-solid fa-users-rectangle stat-icon"></i><div class="stat-number">542</div><div class="stat-label">Total Fellowships</div></div>
            <div class="stat-card"><i class="fa-solid fa-spider stat-icon"></i><div class="stat-number">12</div><div class="stat-label">Web</div></div>
            <div class="stat-card"><i class="fa-solid fa-brain stat-icon"></i><div class="stat-number">8</div><div class="stat-label">AI</div></div>
            <div class="stat-card"><i class="fa-solid fa-mobile-screen stat-icon"></i><div class="stat-number">10</div><div class="stat-label">App</div></div>
            <div class="stat-card"><i class="fa-solid fa-link stat-icon"></i><div class="stat-number">5</div><div class="stat-label">Chain</div></div>
        </div>

        <div class="control-panel">
            <div class="btn-group-actions">
                <button class="action-btn" onclick="openAddModal()">
                    <i class="fa-solid fa-feather-pointed me-2"></i> Inscribe New Quest
                </button>
                <button class="action-btn approve-btn" onclick="window.location.href='accept_team.html'">
                    <i class="fa-solid fa-stamp me-2"></i> Approve Fellowships
                </button>
                <button class="action-btn" onclick="window.location.href='review_marks.html'">
                    <i class="fa-solid fa-star me-2"></i> Add Review Marks
                </button>
                <button class="action-btn" id="loginToggleBtn" onclick="toggleLogin()" style="background: transparent; border: 2px solid var(--gold); color: var(--gold);">
                    <i class="fa-solid fa-key me-2"></i> <span id="loginToggleText">Enable Logins</span>
                </button>
                <button class="action-btn" id="registrationToggleBtn" onclick="toggleRegistration()" style="background: transparent; border: 2px solid var(--gold); color: var(--gold);">
                    <i class="fa-solid fa-scroll me-2"></i> <span id="registrationToggleText">Enable Registration</span>
                </button>
                <button class="action-btn" id="downloadDbBtn" onclick="downloadDatabase()" style="background: transparent; border: 2px solid var(--gold); color: var(--gold);">
                    <i class="fa-solid fa-database me-2"></i> Download Database
                </button>
            </div>

            <div class="filter-group">
                <button class="filter-btn active" onclick="filterQuests('all', this)">All</button>
                <button class="filter-btn" onclick="filterQuests('web', this)">Web</button>
                <button class="filter-btn" onclick="filterQuests('ai', this)">AI</button>
                <button class="filter-btn" onclick="filterQuests('app', this)">App</button>
                <button class="filter-btn" onclick="filterQuests('blockchain', this)">Chain</button>
            </div>
        </div>

        <div class="quest-grid" id="questGrid">
            <!-- Problem statements will be loaded dynamically -->
        </div>
    </div>

    <div class="parchment-overlay" id="addModal">
        <div class="map-container" id="addMap">
            <div class="map-flap flap-left"><span class="flap-content">Inscribe</span></div>
            <div class="map-flap flap-right"><span class="flap-content">New Quest</span></div>

            <div class="map-inner">
                <button class="close-modal" onclick="closeAddModal()"><i class="fa-solid fa-xmark"></i></button>
                <h3 class="scroll-title">Royal Decree</h3>
                
                <form id="addProblemForm" onsubmit="handleAddProblem(event)">
                    <div class="form-group">
                        <label class="ink-label">Quest Title</label>
                        <input type="text" id="problemTitle" class="ink-input" placeholder="e.g. The Triwizard Task" required>
                    </div>

                    <div class="form-group">
                        <label class="ink-label">Domain (Realm)</label>
                        <div class="custom-select-wrapper" id="domainSelect">
                            <div class="custom-select-trigger"><span>Select Realm...</span></div>
                            <div class="custom-options">
                                <span class="custom-option" data-value="web">Web Wizardry</span>
                                <span class="custom-option" data-value="ai">Artificial Intellect</span>
                                <span class="custom-option" data-value="app">Mobile Magic</span>
                                <span class="custom-option" data-value="blockchain">Chain of Secrets</span>
                            </div>
                            <input type="hidden" id="problemDomain" name="domain">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="ink-label">Difficulty Level</label>
                        <div class="custom-select-wrapper" id="difficultySelect">
                            <div class="custom-select-trigger"><span>Select Difficulty...</span></div>
                            <div class="custom-options">
                                <span class="custom-option" data-value="easy">Apprentice</span>
                                <span class="custom-option" data-value="medium">Wizard</span>
                                <span class="custom-option" data-value="hard">Auror</span>
                            </div>
                            <input type="hidden" id="problemDifficulty" name="difficulty">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="ink-label">Description</label>
                        <textarea id="problemDescription" class="ink-textarea" rows="3" required></textarea>
                    </div>

                    <button type="submit" class="submit-seal-btn">Proclaim Quest</button>
                </form>
            </div>
        </div>
    </div>

    <div class="parchment-overlay simple-modal-frame" id="viewModal">
        <div class="parchment-modal">
            <button class="close-modal" onclick="closeModal('viewModal')"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="scroll-title" id="viewModalTitle">Quest Manifest</h3>
            <ul class="manifest-list">
                <li class="manifest-item"><span>Dumbledore's Army</span><span>4 Wizards</span></li>
                <li class="manifest-item"><span>The Marauders</span><span>3 Wizards</span></li>
                <li class="manifest-item"><span>Order of the Phoenix</span><span>4 Wizards</span></li>
            </ul>
        </div>
    </div>

    <div class="parchment-overlay simple-modal-frame" id="approveModal">
        <div class="parchment-modal">
            <button class="close-modal" onclick="closeModal('approveModal')"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="scroll-title">Pending Approvals</h3>
            <p style="text-align: center; font-family: 'Crimson Text'; margin-bottom: 20px; color: #5d4037;">The Ministry awaits your seal.</p>
            
            <ul class="manifest-list" id="approvalList">
                <li class="manifest-item">
                    <div class="team-info">
                        <span class="team-name">The Nifflers</span>
                        <span class="quest-name">Quest: Gringotts Ledger</span>
                    </div>
                    <div class="approval-actions">
                        <button class="btn-approve" onclick="approveTeam(this)" title="Accept"><i class="fa-solid fa-check"></i></button>
                        <button class="btn-reject" onclick="rejectTeam(this)" title="Reject"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </li>
                <li class="manifest-item">
                    <div class="team-info">
                        <span class="team-name">Potter's Parsers</span>
                        <span class="quest-name">Quest: Snitch Predictor</span>
                    </div>
                    <div class="approval-actions">
                        <button class="btn-approve" onclick="approveTeam(this)"><i class="fa-solid fa-check"></i></button>
                        <button class="btn-reject" onclick="rejectTeam(this)"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </li>
                <li class="manifest-item">
                    <div class="team-info">
                        <span class="team-name">Weasley's Widgets</span>
                        <span class="quest-name">Quest: Potion Recipe Vault</span>
                    </div>
                    <div class="approval-actions">
                        <button class="btn-approve" onclick="approveTeam(this)"><i class="fa-solid fa-check"></i></button>
                        <button class="btn-reject" onclick="rejectTeam(this)"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </li>
            </ul>
        </div>
    </div>

    <script>
        // --- WAND CURSOR ---
        const wand = document.getElementById('wand');
        const isDesktop = window.matchMedia("(min-width: 992px)");
        
        if (isDesktop.matches) {
            window.addEventListener('mousemove', (e) => {
                const x = e.clientX;
                const y = e.clientY;
                const angle = 15 * (Math.PI / 180); // Convert to radians
                wand.style.transform = `translate(${x}px, ${y}px) rotate(${15}deg)`;
                
                // Create trail particles at wand tip
                const wandRect = wand.getBoundingClientRect();
                const tipRelX = (wandRect.width / 2) - 20; // Move more to the left
                const tipRelY = -5; // Move down slightly
                
                // Apply rotation transformation around origin (0,0)
                const tipX = wandRect.left + tipRelX * Math.cos(angle) - tipRelY * Math.sin(angle);
                const tipY = wandRect.top + tipRelX * Math.sin(angle) + tipRelY * Math.cos(angle);
                
                const trail = document.createElement('div');
                trail.classList.add('cursor-trail');
                trail.style.left = `${tipX}px`;
                trail.style.top = `${tipY}px`;
                document.body.appendChild(trail);
                setTimeout(() => trail.remove(), 500);
            });
        }

        // --- MODAL OPENERS ---
        function openAddModal() {
            document.getElementById('addModal').classList.add('active');
            setTimeout(() => { document.getElementById('addMap').classList.add('open'); }, 100);
        }

        function closeAddModal() {
            document.getElementById('addMap').classList.remove('open');
            setTimeout(() => { document.getElementById('addModal').classList.remove('active'); }, 800);
        }


        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        document.querySelectorAll('.parchment-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if(e.target === overlay) {
                    if(overlay.id === 'addModal') closeAddModal();
                    else overlay.classList.remove('active');
                }
            });
        });

        // --- CUSTOM DROPDOWN LOGIC ---
        document.querySelectorAll('.custom-select-wrapper').forEach(wrapper => {
            const trigger = wrapper.querySelector('.custom-select-trigger');
            const options = wrapper.querySelectorAll('.custom-option');
            const hiddenInput = wrapper.querySelector('input[type="hidden"]');

            trigger.addEventListener('click', () => { wrapper.classList.toggle('open'); });

            options.forEach(option => {
                option.addEventListener('click', () => {
                    trigger.querySelector('span').textContent = option.textContent;
                    hiddenInput.value = option.getAttribute('data-value');
                    wrapper.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    wrapper.classList.remove('open');
                });
            });
        });
        window.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-select-wrapper')) {
                document.querySelectorAll('.custom-select-wrapper').forEach(w => w.classList.remove('open'));
            }
        });

        // Load problem statements on page load
        async function loadProblemStatements() {
            try {
                const response = await fetch('/api/admin/problem-statements');
                const data = await response.json();
                
                if (data.success) {
                    const grid = document.getElementById('questGrid');
                    grid.innerHTML = '';
                    
                    if (data.statements.length === 0) {
                        grid.innerHTML = '<p style="color: #aaa; text-align: center; grid-column: 1/-1; font-family: \'Crimson Text\';">No problem statements yet. Add one to get started!</p>';
                        return;
                    }
                    
                    data.statements.forEach(stmt => {
                        const card = document.createElement('div');
                        card.className = `admin-card filter-item ${stmt.domain}`;
                        card.setAttribute('data-stmt-id', stmt.id);
                        card.innerHTML = `
                            <span class="card-tag">${stmt.domain.charAt(0).toUpperCase() + stmt.domain.slice(1)}</span>
                            <h3 class="card-title">${stmt.title}</h3>
                            <p class="card-desc">${stmt.description}</p>
                            <div class="card-meta">
                                <span class="count-display"><strong>${stmt.selected_count || 0}</strong> Wizards Opted</span>
                                <div class="card-actions">
                                    <button class="btn-icon btn-view" onclick="openViewModal(${stmt.id}, '${stmt.title.replace(/'/g, "\\'")}')"><i class="fa-solid fa-eye"></i> View</button>
                                    <button class="btn-icon btn-del" onclick="deleteCard(this, ${stmt.id})"><i class="fa-solid fa-fire"></i> Burn</button>
                                </div>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Error loading problem statements:', error);
            }
        }
        
        // Check if admin is logged in
        const isAdmin = sessionStorage.getItem('isAdmin');
        const adminName = sessionStorage.getItem('adminName');
        
        if (!isAdmin || !adminName) {
            // Redirect to admin login if not logged in
            window.location.href = '/admin-login';
        } else {
            document.getElementById('adminNameDisplay').textContent = `Welcome, ${adminName}`;
        }
        
        // Logout function
        function logout() {
            sessionStorage.removeItem('isAdmin');
            sessionStorage.removeItem('adminName');
        }
        
        // Load on page load
        loadProblemStatements();
        
        // Check login toggle status
        async function checkLoginToggle() {
            try {
                const response = await fetch('/api/admin/login-toggle');
                const data = await response.json();
                if (data.success) {
                    const btn = document.getElementById('loginToggleBtn');
                    const text = document.getElementById('loginToggleText');
                    if (data.enabled) {
                        btn.style.background = 'var(--gold)';
                        btn.style.color = '#000';
                        text.textContent = 'Disable Logins';
                    } else {
                        btn.style.background = 'transparent';
                        btn.style.color = 'var(--gold)';
                        text.textContent = 'Enable Logins';
                    }
                }
            } catch (error) {
                console.error('Error checking login toggle:', error);
            }
        }
        
        checkLoginToggle();
        
        // Toggle login
        async function toggleLogin() {
            try {
                const response = await fetch('/api/admin/login-toggle');
                const data = await response.json();
                if (data.success) {
                    const newState = !data.enabled;
                    const toggleResponse = await fetch('/api/admin/login-toggle', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enabled: newState })
                    });
                    const toggleData = await toggleResponse.json();
                    if (toggleData.success) {
                        checkLoginToggle();
                    }
                }
            } catch (error) {
                console.error('Error toggling login:', error);
                alert('Error toggling login. Please try again.');
            }
        }
        
        // Check registration toggle status
        async function checkRegistrationToggle() {
            try {
                const response = await fetch('/api/admin/registration-toggle');
                const data = await response.json();
                if (data.success) {
                    const btn = document.getElementById('registrationToggleBtn');
                    const text = document.getElementById('registrationToggleText');
                    if (data.enabled) {
                        btn.style.background = 'var(--gold)';
                        btn.style.color = '#000';
                        text.textContent = 'Disable Registration';
                    } else {
                        btn.style.background = 'transparent';
                        btn.style.color = 'var(--gold)';
                        text.textContent = 'Enable Registration';
                    }
                }
            } catch (error) {
                console.error('Error checking registration toggle:', error);
            }
        }
        
        checkRegistrationToggle();
        
        // Toggle registration
        async function toggleRegistration() {
            try {
                const response = await fetch('/api/admin/registration-toggle');
                const data = await response.json();
                if (data.success) {
                    const newState = !data.enabled;
                    const toggleResponse = await fetch('/api/admin/registration-toggle', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ enabled: newState })
                    });
                    const toggleData = await toggleResponse.json();
                    if (toggleData.success) {
                        checkRegistrationToggle();
                    }
                }
            } catch (error) {
                console.error('Error toggling registration:', error);
                alert('Error toggling registration. Please try again.');
            }
        }
        
        // Handle add problem form
        async function handleAddProblem(event) {
            event.preventDefault();
            
            const title = (document.getElementById('problemTitle').value || '').trim();
            const description = (document.getElementById('problemDescription').value || '').trim();
            const domain = document.getElementById('problemDomain').value || '';
            const difficulty = document.getElementById('problemDifficulty').value || '';
            const house = null; // Always null - available to all houses
            
            if (!title || !description || !domain || !difficulty) {
                alert('Please fill in all required fields');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/problem-statements', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        title: title || '', 
                        description: description || '', 
                        domain: domain || '', 
                        difficulty: difficulty || '', 
                        house: house 
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    closeAddModal();
                    document.getElementById('addProblemForm').reset();
                    // Reset dropdowns
                    document.querySelector('#domainSelect .custom-select-trigger span').textContent = 'Select Realm...';
                    document.querySelector('#difficultySelect .custom-select-trigger span').textContent = 'Select Difficulty...';
                    loadProblemStatements();
                } else {
                    alert(data.error || 'Failed to add problem statement');
                }
            } catch (error) {
                console.error('Error adding problem statement:', error);
                alert('Error adding problem statement. Please try again.');
            }
        }
        
        // Update delete function
        async function deleteCard(btn, stmtId) {
            if(confirm("Are you sure you want to burn this scroll?")) {
                try {
                    const response = await fetch(`/api/admin/problem-statements/${stmtId}`, {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    if (data.success) {
                        const card = btn.closest('.admin-card');
                        card.style.transition = "0.5s";
                        card.style.transform = "scale(0) rotate(20deg)";
                        card.style.opacity = "0";
                        setTimeout(() => card.remove(), 500);
                    } else {
                        alert(data.error || 'Failed to delete problem statement');
                    }
                } catch (error) {
                    console.error('Error deleting problem statement:', error);
                    alert('Error deleting problem statement. Please try again.');
                }
            }
        }
        
        // Update view modal to show teams that selected the statement
        async function openViewModal(stmtId, title) {
            document.getElementById('viewModalTitle').innerText = title;
            const list = document.querySelector('#viewModal .manifest-list');
            list.innerHTML = '<li class="manifest-item"><span>Loading...</span></li>';
            document.getElementById('viewModal').classList.add('active');
            
            try {
                // Get teams that selected this specific statement
                const response = await fetch(`/api/admin/problem-statements/${stmtId}/teams`);
                const data = await response.json();
                if (data.success) {
                    list.innerHTML = '';
                    if (data.teams.length === 0) {
                        list.innerHTML = '<li class="manifest-item"><span>No teams have applied for this quest yet</span></li>';
                    } else {
                        data.teams.forEach(team => {
                            const item = document.createElement('li');
                            item.className = 'manifest-item';
                            item.innerHTML = `<span>${team.name}</span><span>${team.members.length} Wizards</span>`;
                            list.appendChild(item);
                        });
                    }
                } else {
                    list.innerHTML = '<li class="manifest-item"><span>Error loading teams</span></li>';
                }
            } catch (error) {
                console.error('Error loading teams:', error);
                list.innerHTML = '<li class="manifest-item"><span>Error loading teams</span></li>';
            }
        }

        function filterQuests(category, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const cards = document.querySelectorAll('.filter-item');
            cards.forEach(card => {
                card.style.display = "none";
                card.classList.remove('fade-in');
                if (category === 'all' || card.classList.contains(category)) {
                    card.style.display = "flex";
                    setTimeout(() => card.classList.add('fade-in'), 10);
                }
            });
        }

        // Download database function (admin only)
        async function downloadDatabase() {
            // Get admin credentials from session
            const adminName = sessionStorage.getItem('adminName');
            if (!adminName) {
                alert('Admin session expired. Please login again.');
                window.location.href = '/admin-login';
                return;
            }
            
            const password = prompt('Enter admin password to download database:');
            if (!password) return;
            
            try {
                const apiUrl = `/api/admin/download-db?username=${encodeURIComponent(adminName)}&password=${encodeURIComponent(password)}`;
                const response = await fetch(apiUrl, {
                    method: 'GET',
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'hogwarts_hackathon.db';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to download database');
                }
            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading database: ' + error.message);
            }
        }

    </script>
</body>
</html>