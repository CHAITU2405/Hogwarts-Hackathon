<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Teams - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Crimson+Text:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --gold: #d4af37;
            --bg-dark: #0b0b0b;
            --parchment: #efe5cf;
            --ink: #2a1b15;
        }

        body {
            background: radial-gradient(circle at center, #1f1f35 0%, #000000 100%);
            color: #eee;
            font-family: 'Crimson Text', serif;
            min-height: 100vh;
            /* Disable text selection */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        .navbar { background-color: rgba(10, 10, 10, 0.9); border-bottom: 1px solid rgba(212, 175, 55, 0.3); padding: 1rem 0; z-index: 100; backdrop-filter: blur(10px); }
        .navbar-brand { 
            font-family: 'Cinzel Decorative'; 
            font-weight: 900; 
            text-transform: uppercase; 
            line-height: 1.1; 
            color: #ffd700; 
            filter: url(#gold-texture); 
            font-size: 1.5rem; 
            transition: 0.3s;
        }
        @media (max-width: 768px) { 
            .navbar-brand { font-size: 1.2rem; } 
        }
        .nav-link { font-family: 'Cinzel Decorative'; color: var(--gold); transition: 0.3s; }
        .nav-link:hover { color: #fff; text-shadow: 0 0 15px var(--gold); }
        
        /* Volume Control Button */
        .volume-btn {
            color: var(--gold);
            font-size: 1.2rem;
            padding: 5px 10px;
            border: none;
            background: transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .volume-btn:hover {
            color: #ffd700;
            transform: scale(1.1);
        }
        .volume-btn.volume-off {
            opacity: 0.6;
        }
        .volume-btn.volume-on {
            opacity: 1;
        }

        .page-header {
            text-align: center;
            margin: 40px 0;
        }

        .page-title {
            font-family: 'Cinzel Decorative';
            font-size: 3rem;
            color: var(--gold);
            text-shadow: 0 0 20px rgba(212,175,55,0.4);
        }

        .team-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(212,175,55,0.3);
        }

        .team-name {
            font-family: 'Cinzel Decorative';
            font-size: 1.8rem;
            color: var(--gold);
            margin: 0;
        }

        .team-info {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: #aaa;
        }

        .team-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .members-section {
            margin-top: 20px;
        }

        .members-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .members-title {
            font-family: 'Cinzel Decorative';
            font-size: 1.2rem;
            color: var(--gold);
        }

        .btn-add-member {
            background: linear-gradient(135deg, #2a5d2a, #1a3d1a);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 8px 16px;
            border-radius: 6px;
            font-family: 'Cinzel Decorative';
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-add-member:hover {
            background: linear-gradient(135deg, #3a7d3a, #2a5d2a);
            box-shadow: 0 0 15px rgba(212,175,55,0.5);
        }

        .btn-add-member:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .members-list {
            display: grid;
            gap: 12px;
        }

        .member-item {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(212,175,55,0.2);
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s;
        }

        .member-item:hover {
            background: rgba(0,0,0,0.5);
            border-color: rgba(212,175,55,0.4);
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-family: 'Cinzel Decorative';
            font-size: 1.1rem;
            color: #fff;
            margin-bottom: 5px;
        }

        .member-name.leader {
            color: var(--gold);
        }

        .member-name.leader::after {
            content: " (Leader)";
            font-size: 0.8rem;
            color: var(--gold);
        }

        .member-details {
            font-size: 0.85rem;
            color: #aaa;
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .btn-remove {
            background: rgba(198, 40, 40, 0.3);
            border: 1px solid #c62828;
            color: #ff5252;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.85rem;
        }

        .btn-remove:hover {
            background: #c62828;
            color: #fff;
            box-shadow: 0 0 10px rgba(198, 40, 40, 0.6);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #aaa;
            font-style: italic;
        }

        /* Modal for adding member */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-overlay.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: linear-gradient(135deg, #2a2420, #1a1613);
            border: 2px solid var(--gold);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 0 30px rgba(212,175,55,0.3);
        }

        .modal-header {
            font-family: 'Cinzel Decorative';
            font-size: 1.5rem;
            color: var(--gold);
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-family: 'Cinzel Decorative';
            color: var(--gold);
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(212,175,55,0.3);
            border-radius: 6px;
            color: #fff;
            font-family: 'Crimson Text';
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 10px rgba(212,175,55,0.3);
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-checkbox input {
            width: 18px;
            height: 18px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn-modal {
            padding: 10px 20px;
            border-radius: 6px;
            font-family: 'Cinzel Decorative';
            cursor: pointer;
            transition: 0.3s;
            border: none;
        }

        .btn-cancel {
            background: rgba(100,100,100,0.3);
            color: #ccc;
        }

        .btn-cancel:hover {
            background: rgba(100,100,100,0.5);
        }

        .btn-submit {
            background: linear-gradient(135deg, #2a5d2a, #1a3d1a);
            color: var(--gold);
            border: 1px solid var(--gold);
        }

        .btn-submit:hover {
            background: linear-gradient(135deg, #3a7d3a, #2a5d2a);
            box-shadow: 0 0 15px rgba(212,175,55,0.5);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-family: 'Cinzel Decorative';
        }

        .status-pending {
            background: rgba(255, 167, 38, 0.2);
            color: #ffa726;
            border: 1px solid #ffa726;
        }

        .status-approved {
            background: rgba(102, 187, 106, 0.2);
            color: #66bb6a;
            border: 1px solid #66bb6a;
        }

        .status-rejected {
            background: rgba(239, 83, 80, 0.2);
            color: #ef5350;
            border: 1px solid #ef5350;
        }

        .search-container {
            max-width: 600px;
            margin: 30px auto 40px;
            position: relative;
        }

        .search-bar {
            width: 100%;
            padding: 12px 50px 12px 20px;
            background: rgba(0,0,0,0.5);
            border: 2px solid rgba(212,175,55,0.3);
            border-radius: 30px;
            color: #fff;
            font-family: 'Crimson Text', serif;
            font-size: 1rem;
            transition: 0.3s;
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(212,175,55,0.4);
            background: rgba(0,0,0,0.7);
        }

        .search-bar::placeholder {
            color: #888;
            font-style: italic;
        }

        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gold);
            font-size: 1.2rem;
            pointer-events: none;
        }

        .search-results-info {
            text-align: center;
            color: #aaa;
            font-size: 0.9rem;
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg sticky-top navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="main.html">
                <span style="display: block;">Hogwarts</span>
                <span style="display: block;">Hackathon</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
            <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
                <ul class="navbar-nav align-items-center">
                    <li class="nav-item me-3">
                        <button id="volumeControl" class="btn btn-link volume-btn" type="button" title="Toggle Background Music">
                            <i class="fas fa-volume-up"></i>
                        </button>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="main.html#home">Great Hall</a></li>
                    <li class="nav-item"><a class="nav-link" href="teams.html">Teams</a></li>
                    <li class="nav-item"><a class="nav-link" href="organizers.html">Organizers</a></li>
                    <li class="nav-item"><a class="nav-link" href="timeline.html">Timeline</a></li>
                    <li class="nav-item"><a class="nav-link" href="rules.html">Rules</a></li>
                    <li class="nav-item"><a class="nav-link" href="faq.html">FAQs</a></li>
                    <li class="nav-item"><a class="nav-link" href="admin.html" style="color: var(--gold);">Admin</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div class="page-header">
            <h1 class="page-title">Manage Teams</h1>
            <p style="color: #aaa; font-style: italic;">Add or remove team members</p>
        </div>

        <div class="search-container">
            <input type="text" class="search-bar" id="searchInput" placeholder="Search by team name, house, or member name...">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <div class="search-results-info" id="searchResultsInfo" style="display: none;"></div>
        </div>

        <div id="teamsContainer">
            <!-- Teams will be loaded here -->
        </div>
    </div>

    <!-- Modal for adding member -->
    <div class="modal-overlay" id="addMemberModal">
        <div class="modal-content">
            <div class="modal-header">Add New Member</div>
            <form id="addMemberForm">
                <input type="hidden" id="modalTeamId">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="memberName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="memberEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="text" class="form-input" id="memberPhone" required>
                </div>
                <div class="form-group">
                    <label class="form-label">College Name</label>
                    <input type="text" class="form-input" id="memberCollege" placeholder="e.g., Hogwarts School" required>
                </div>
                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="memberIsLeader">
                        <label class="form-label" for="memberIsLeader" style="margin: 0;">Set as Team Leader</label>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-modal btn-cancel" onclick="closeAddMemberModal()">Cancel</button>
                    <button type="submit" class="btn-modal btn-submit">Add Member</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="disable-copy.js"></script>
    <script>
        let teams = [];
        let filteredTeams = [];
        let searchQuery = '';

        async function loadTeams() {
            const container = document.getElementById('teamsContainer');
            container.innerHTML = '<div class="empty-state"><i class="fa-solid fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 10px;"></i><br>Loading teams...</div>';
            
            try {
                console.log('Fetching teams from /api/admin/all-teams');
                const response = await fetch('/api/admin/all-teams', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Response status:', response.status, response.statusText);
                console.log('Response URL:', response.url);
                
                if (response.status === 404) {
                    container.innerHTML = `<div class="empty-state" style="color: #ff5252;">
                        <i class="fa-solid fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i><br>
                        <strong>Route Not Found (404)</strong><br><br>
                        The API endpoint is not available. This usually means:<br><br>
                        1. <strong>The Flask server needs to be restarted</strong><br>
                        2. Stop the server (Ctrl+C) and restart it: <code>python app.py</code><br>
                        3. Then refresh this page<br><br>
                        <small style="color: #888;">If the problem persists, check the Flask server console for errors.</small>
                    </div>`;
                    return;
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('HTTP Error:', response.status, errorText);
                    let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMsg = errorJson.error || errorMsg;
                    } catch (e) {
                        errorMsg = errorText || errorMsg;
                    }
                    throw new Error(errorMsg);
                }
                
                const data = await response.json();
                console.log('Teams data received:', data);
                
                if (data.success) {
                    teams = data.teams || [];
                    filteredTeams = teams;
                    renderTeams();
                } else {
                    console.error('API Error:', data);
                    container.innerHTML = `<div class="empty-state" style="color: #ff5252;">Error: ${data.error || 'Unknown error'}</div>`;
                }
            } catch (error) {
                console.error('Error loading teams:', error);
                if (error.message.includes('404') || error.message.includes('Not Found')) {
                    container.innerHTML = `<div class="empty-state" style="color: #ff5252;">
                        <i class="fa-solid fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i><br>
                        <strong>Route Not Found</strong><br><br>
                        Please <strong>restart your Flask server</strong> to load the new route:<br><br>
                        1. Stop the server (Ctrl+C in terminal)<br>
                        2. Start it again: <code>python app.py</code><br>
                        3. Refresh this page<br><br>
                        <small style="color: #888;">The route exists in the code but needs the server to be restarted.</small>
                    </div>`;
                } else {
                    container.innerHTML = `<div class="empty-state" style="color: #ff5252;">
                        <i class="fa-solid fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 10px;"></i><br>
                        Error loading teams: ${error.message}<br><br>
                        <small style="color: #888;">Check the browser console (F12) for more details.</small>
                    </div>`;
                }
            }
        }

        function filterTeams() {
            if (!searchQuery.trim()) {
                filteredTeams = teams;
            } else {
                const query = searchQuery.toLowerCase().trim();
                filteredTeams = teams.filter(team => {
                    // Search in team name
                    if (team.team_name && team.team_name.toLowerCase().includes(query)) {
                        return true;
                    }
                    // Search in house
                    if (team.house && team.house.toLowerCase().includes(query)) {
                        return true;
                    }
                    // Search in member names
                    if (team.members && team.members.some(member => 
                        member.name && member.name.toLowerCase().includes(query)
                    )) {
                        return true;
                    }
                    // Search in member emails
                    if (team.members && team.members.some(member => 
                        member.email && member.email.toLowerCase().includes(query)
                    )) {
                        return true;
                    }
                    return false;
                });
            }
            
            // Update search results info
            const resultsInfo = document.getElementById('searchResultsInfo');
            if (searchQuery.trim()) {
                resultsInfo.style.display = 'block';
                resultsInfo.textContent = `Found ${filteredTeams.length} team${filteredTeams.length !== 1 ? 's' : ''} matching "${searchQuery}"`;
            } else {
                resultsInfo.style.display = 'none';
            }
            
            renderTeams();
        }

        function renderTeams() {
            const container = document.getElementById('teamsContainer');
            
            if (!teams || teams.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fa-solid fa-users-slash" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i><br>No teams found in the database</div>';
                return;
            }

            if (filteredTeams.length === 0 && searchQuery.trim()) {
                container.innerHTML = `<div class="empty-state">
                    <i class="fa-solid fa-search" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i><br>
                    No teams found matching "${searchQuery}"<br>
                    <small style="color: #888; margin-top: 10px; display: block;">Try a different search term</small>
                </div>`;
                return;
            }

            container.innerHTML = filteredTeams.map(team => {
                const members = team.members || [];
                const statusClass = team.approval_status === 'approved' ? 'status-approved' : 
                                   team.approval_status === 'rejected' ? 'status-rejected' : 'status-pending';
                const statusText = team.approval_status.charAt(0).toUpperCase() + team.approval_status.slice(1);
                const canAddMember = members.length < 4;

                return `
                    <div class="team-card">
                        <div class="team-header">
                            <div>
                                <h3 class="team-name">${team.team_name}</h3>
                                <div class="team-info">
                                    <span><i class="fa-solid fa-building"></i> ${team.house}</span>
                                    <span><i class="fa-solid fa-users"></i> ${members.length}/4 Members</span>
                                    <span class="status-badge ${statusClass}">${statusText}</span>
                                </div>
                            </div>
                        </div>
                        <div class="members-section">
                            <div class="members-header">
                                <h4 class="members-title">Team Members</h4>
                                <button class="btn-add-member" onclick="openAddMemberModal(${team.id})" ${!canAddMember ? 'disabled' : ''}>
                                    <i class="fa-solid fa-plus"></i> Add Member
                                </button>
                            </div>
                            <div class="members-list">
                                ${members.length === 0 ? '<div class="empty-state">No members yet</div>' : 
                                  members.map(member => `
                                    <div class="member-item">
                                        <div class="member-info">
                                            <div class="member-name ${member.is_leader ? 'leader' : ''}">${member.name}</div>
                                            <div class="member-details">
                                                <span><i class="fa-solid fa-envelope"></i> ${member.email}</span>
                                                <span><i class="fa-solid fa-phone"></i> ${member.phone}</span>
                                                <span><i class="fa-solid fa-graduation-cap"></i> ${member.college_name || 'Not provided'}</span>
                                            </div>
                                        </div>
                                        <button class="btn-remove" onclick="removeMember(${team.id}, ${member.id})" ${members.length <= 1 ? 'disabled title="Cannot remove last member"' : ''}>
                                            <i class="fa-solid fa-trash"></i> Remove
                                        </button>
                                    </div>
                                  `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openAddMemberModal(teamId) {
            document.getElementById('modalTeamId').value = teamId;
            document.getElementById('addMemberModal').classList.add('show');
            document.getElementById('addMemberForm').reset();
        }

        function closeAddMemberModal() {
            document.getElementById('addMemberModal').classList.remove('show');
        }

        document.getElementById('addMemberForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const teamId = document.getElementById('modalTeamId').value;
            const name = document.getElementById('memberName').value.trim();
            const email = document.getElementById('memberEmail').value.trim();
            const phone = document.getElementById('memberPhone').value.trim();
            const college = document.getElementById('memberCollege').value.trim();
            const isLeader = document.getElementById('memberIsLeader').checked;

            if (!name || !email || !phone || !college) {
                alert('Please fill in all fields including college name');
                return;
            }

            try {
                const response = await fetch(`/api/admin/teams/${teamId}/members`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        email: email,
                        phone: phone,
                        college_name: college,
                        is_leader: isLeader
                    })
                });

                const data = await response.json();

                if (data.success) {
                    closeAddMemberModal();
                    await loadTeams(); // Reload teams
                    // Reapply search filter if active
                    if (searchQuery.trim()) {
                        filterTeams();
                    }
                } else {
                    alert('Error adding member: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding member:', error);
                alert('Error adding member. Please try again.');
            }
        });

        async function removeMember(teamId, memberId) {
            if (!confirm('Are you sure you want to remove this member? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/teams/${teamId}/members/${memberId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    await loadTeams(); // Reload teams
                    // Reapply search filter if active
                    if (searchQuery.trim()) {
                        filterTeams();
                    }
                } else {
                    alert('Error removing member: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error removing member:', error);
                alert('Error removing member. Please try again.');
            }
        }

        // Close modal on overlay click
        document.getElementById('addMemberModal').addEventListener('click', (e) => {
            if (e.target.id === 'addMemberModal') {
                closeAddMemberModal();
            }
        });

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', (e) => {
            searchQuery = e.target.value;
            filterTeams();
        });

        // Load teams on page load
        loadTeams();
    </script>
</body>
</html>

